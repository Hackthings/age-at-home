#!/bin/csh

if ($?CLOUDANT_DATABASE) then
    setenv DB "$CLOUDANT_DATABASE"
else
    setenv DB "rough-fog"
endif

if ( $#argv > 0 ) then
    setenv ALLROWS "$argv[1]".csv
else
    setenv ALLROWS "$DB".csv
endif

set classifier = ( 'person' )

setenv ARBASE "$ALLROWS:r"
setenv OUTPUT "$ARBASE-$classifier-days.json"

if (! -e "$ALLROWS" ) then
    echo "$ALLROWS does not exist; run $0:h/getjson2csv"
else if ( ! -e "$ARBASE-class-values.csv" ) then
    echo "$ARBASE-class-values.csv does not exist; run $0:h/mkclassvalues"
else if ( ! -e "$ARBASE-day-ampm.csv" ) then
    echo "$ARBASE-day-ampm.csv does not exists; run $0:h/mkdayampm"
else if ( ! -e "$ARBASE-$classifier-days.csv" ) then
    echo "$ARBASE-$classsifier-days.csv does not exists; run $0:h/mkclassdays"
else if (! -e "$OUTPUT" ) then
    echo "STAT: creating $OUTPUT"

    awk -f "$0:h/csv2json.awk" "$ARBASE-$classifier-days.csv" | tr \' \" | sed 's/""/"/g' >! "$OUTPUT"
else
    echo "$OUTPUT exists"
endif
