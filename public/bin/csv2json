#!/bin/csh

if ($?CLOUDANT_DATABASE) then
    setenv DB "$CLOUDANT_DATABASE"
else
    setenv DB "rough-fog"
endif

if ( $#argv > 0 ) then
    setenv ALLROWS "$argv[1]".csv
    if ($#argv > 1) then
	setenv CLASSIFIER "$argv[2]"
	if ($#argv > 2) then
	    setenv BUCKET "$argv[3]"
	endif
    endif
else
    setenv ALLROWS "$DB".csv
endif

if ($?CLASSIFER == 0) then
    set classifier = ( 'person' )
else
    set classifier = "$CLASSIFIER"
endif

if ($?BUCKET == 0) then
    set bucket = ( 'doc/hour' )
else
    set bucket = "$BUCKET"
endif

setenv ARBASE "$ALLROWS:r"
setenv OUTPUT "$ARBASE-$classifier-$bucket:t.json"

if (! -e "$ALLROWS" ) then
    echo "$ALLROWS does not exist; run $0:h/getjson2csv $ALLROWS:r"
else if ( ! -e "$ARBASE-class-values.csv" ) then
    echo "$ARBASE-class-values.csv does not exist; run $0:h/mkclassvalues $ALLROWS:r"
else if ( ! -e "$ARBASE-buckets.csv" ) then
    echo "$ARBASE-buckets.csv does not exists; run $0:h/mkbuckets $ALLROWS:r"
else if ( ! -e "$ARBASE-$classifier-$bucket:t.csv" ) then
    echo "$ARBASE-$classsifier-$bucket:t.csv does not exists; run $0:h/mkclassbuckets $ALLROWS:r $classifier $bucket"
else if (! -e "$OUTPUT" ) then
    echo "STAT: creating $OUTPUT"

    awk -f "$0:h/csv2json.awk" "$ARBASE-$classifier-$bucket:t.csv" | tr \' \" | sed 's/""/"/g' >! "$OUTPUT"
else
    echo "$OUTPUT exists"
endif
