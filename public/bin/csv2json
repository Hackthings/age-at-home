#!/bin/tcsh

if ($?CLOUDANT_DATABASE) then
    setenv DB "$CLOUDANT_DATABASE"
else
    setenv DB "rough-fog"
endif

if ( $#argv > 0 ) then
    setenv ALLROWS "$argv[1]".csv
    if ($#argv > 1) then
	setenv CLASSIFIER "$argv[2]"
	if ($#argv > 2) then
	    setenv INTERVAL "$argv[3]"
	endif
    endif
else
    setenv ALLROWS "$DB".csv
endif

if ($?CLASSIFER == 0) then
    set classifier = ( 'person' )
else
    set classifier = "$CLASSIFIER"
endif

if ($?INTERVAL == 0) then
    set interval = ( 'doc/hour' )
else
    set interval = "$INTERVAL"
endif

setenv ARBASE "$ALLROWS:r"
setenv OUTPUT "$ARBASE-$classifier-$interval:t.json"

if (! -e "$ALLROWS" ) then
    echo "$ALLROWS does not exist; run $0:h/getjson2csv $ALLROWS:r"
else if ( ! -e "$ARBASE-$classifier-values.csv" ) then
    echo "$ARBASE-$classifier-values.csv does not exist; run $0:h/mkclassvalues $ALLROWS:r $classifier"
else if ( ! -e "$ARBASE-intervals.csv" ) then
    echo "$ARBASE-intervals.csv does not exists; run $0:h/mkintervals $ALLROWS:r"
else if ( ! -e "$ARBASE-$classifier-$interval:t.csv" ) then
    echo "$ARBASE-$classsifier-$interval:t.csv does not exists; run $0:h/mkclassintervals $ALLROWS:r $classifier $interval"
else if (! -e "$OUTPUT" ) then
    echo "STAT: creating $OUTPUT"

    awk -f "$0:h/csv2json.awk" "$ARBASE-$classifier-$interval:t.csv" | tr \' \" | sed 's/""/"/g' >! "$OUTPUT"
else
    echo "$OUTPUT exists"
endif
