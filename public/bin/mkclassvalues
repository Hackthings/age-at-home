#!/bin/csh

if ($?CLOUDANT_DATABASE) then
    setenv DB "$CLOUDANT_DATABASE"
else
    setenv DB "rough-fog"
endif

if ( -e "$DB.csv" ) then
    set k = `csvstat -n $DB.csv | awk '{ print $2 }'`
    set s = `echo $k | sed "s/ /,/g"`
    set g = `csvstat -n $DB.csv | awk '{ print $2 }' | egrep classifier_id`
    set t = `echo $g | sed "s/ /,/g"`
    set h = ()
    foreach i ( $g )
        set h = ( $h $i:h/score )
    end
    set u = `echo $h | sed "s/ /,/g"`

    if ( ! -e "$DB-classes.txt" ) then
	echo "STAT: making $DB-classes.txt"
	foreach i ( $g )
	    csvcut -c $i "$DB".csv | tail +2 >>! "$DB"-classes.txt
	    cat "$DB"-classes.txt | sort | uniq >! tmp.$$
	    mv -f tmp.$$ "$DB"-classes.txt
	end
    endif
else
    exit
endif

set classifiers = ( `cat "$DB"-classes.txt` )
if ($#classifiers > 1) then
    echo "STAT: total $#classifiers"
    set datetime = ( doc/year doc/month doc/day doc/hour doc/minute doc/second )
    set dtcolumns = `echo "$datetime" | sed "s/ /,/g"`
    echo "classifier,score,id,$dtcolumns" >! "$DB-class-values.csv"
    foreach i ( $classifiers )
	if ($i == \"\") continue

	echo -n "STAT: $i"
	echo "$s" >! "$i.csv"
	egrep ",$i," "$DB.csv" >> "$i.csv"
	foreach j ( $g )
	    csvcut -c "$j","$j:h/score","id","$dtcolumns" "$i.csv" | egrep "^$i," >> "$DB-class-values.csv"
	    echo -n "."
	end
	rm "$i.csv"
	echo 
    end
endif
